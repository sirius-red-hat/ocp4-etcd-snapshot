# https://access.redhat.com/articles/4047481
---
node-anchors:
  name: &name master-0.ocpa
  snapdir: &snapdir /var/home/core/etcd-snapshots

apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: etcd-snapshotter
  labels:
    taranto.dev/app: etcd-snapshots
spec:
  concurrentPolicy: Forbid
  # Node is in UTC, which is -5 from a real TZ.
  schedule: "0 */8 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          nodeSelector:
            etcd-snapshot.taranto.dev/role: snapshot
          tolerations:
          - key: "node-role.kubernetes.io/master"
            operator: "Exists"
            effect: "NoSchedule"
          containers:
          - name: etcd-snapshotter
            image: registry.access.redhat.com/rhel7/rhel-tools 
            imagePullPolicy: IfNotPresent
            command: [ "chroot", "/host", "/usr/local/bin/etcd-snapshot.sh", "pod-mode", *snapdir, "3" ]
            securityContext:
              privileged: true
              runAsUser: 0
              runAsGroup: 0
            volumeMounts:
            - name: node-root
              mountPath: /host
              readOnly: false
              mountPropagation: HostToContainer
            - name: etcd-snapshot
              mountPath: *snapdir
              readOnly: false
          restartPolicy: Never
          serviceAccountName: etcd-snapshot
          terminationGracePeriodSeconds: 1
          volumes:
          - name: etcd-snapshot
            persistentVolumeClaim: 
              claimName: pvc-etcd-snapshot
          - name: node-root
            hostPath:
              path: /
              type: Directory
...
